#!/bin/sh

# Pre-push hook: Four-phase testing
# Phase 1: Unit tests (fast, ~11s)
# Phase 2: Smoke test (fast, ~20s, Chromium only)
# Phase 3: Full E2E test (comprehensive, ~3-5min, Chromium + Firefox + WebKit)
# Phase 4: Mobile Safari test (~2min, iPhone viewport + touch)
#
# REQUIRES: wrangler dev running on port 8787 (for E2E tests)
# Start with: npm run build && npx wrangler dev

set -e

cd app

echo ""
echo "========================================"
echo "  PRE-PUSH: Test Suite"
echo "========================================"
echo ""

# Phase 1: Unit Tests (runs first, no backend required)
echo "----------------------------------------"
echo "Phase 1: Unit Tests (~11s)"
echo "----------------------------------------"
echo ""

UNIT_START=$(date +%s)

if npm run test:unit; then
    UNIT_END=$(date +%s)
    UNIT_DURATION=$((UNIT_END - UNIT_START))
    echo ""
    echo "✅ Unit tests passed! (${UNIT_DURATION}s)"
    echo ""
else
    echo ""
    echo "❌ Unit tests FAILED"
    echo ""
    echo "Fix the issues above before pushing."
    echo "To skip: git push --no-verify"
    echo ""
    exit 1
fi

# Check if wrangler dev is running (required for E2E tests)
if ! lsof -i:8787 > /dev/null 2>&1; then
    echo "❌ ERROR: wrangler dev is not running on port 8787"
    echo ""
    echo "E2E tests require the real backend for reliable results."
    echo ""
    echo "To start the backend:"
    echo "  cd app && npm run build && npx wrangler dev"
    echo ""
    echo "Then try pushing again."
    echo ""
    echo "To skip E2E tests (not recommended):"
    echo "  git push --no-verify"
    echo ""
    exit 1
fi

echo "✓ Backend detected on port 8787"
echo ""

# Phase 2: Smoke Test (fast feedback)
echo "----------------------------------------"
echo "Phase 2: Smoke Test (~20s, Chromium)"
echo "----------------------------------------"
echo ""

SMOKE_START=$(date +%s)

if npm run test:e2e:smoke; then
    SMOKE_END=$(date +%s)
    SMOKE_DURATION=$((SMOKE_END - SMOKE_START))
    echo ""
    echo "✅ Smoke test passed! (${SMOKE_DURATION}s)"
    echo ""
else
    echo ""
    echo "❌ Smoke test FAILED"
    echo ""
    echo "Fix the issues above before pushing."
    echo "To skip: git push --no-verify"
    echo ""
    exit 1
fi

# Phase 3: Full Test (comprehensive, all browsers)
echo "----------------------------------------"
echo "Phase 3: Full E2E Test (~3-5min, All Browsers)"
echo "----------------------------------------"
echo ""

FULL_START=$(date +%s)

if npm run test:e2e:full; then
    FULL_END=$(date +%s)
    FULL_DURATION=$((FULL_END - FULL_START))
    echo ""
    echo "✅ Full test passed! (${FULL_DURATION}s)"
    echo ""
else
    echo ""
    echo "❌ Full test FAILED"
    echo ""
    echo "Some tests failed on Firefox or WebKit."
    echo "Review the failures above."
    echo "To skip: git push --no-verify"
    echo ""
    exit 1
fi

# Phase 4: Mobile Safari Test (iPhone viewport + touch interactions)
echo "----------------------------------------"
echo "Phase 4: Mobile Safari (~2min, iPhone)"
echo "----------------------------------------"
echo ""

MOBILE_START=$(date +%s)

if npm run test:e2e:mobile; then
    MOBILE_END=$(date +%s)
    MOBILE_DURATION=$((MOBILE_END - MOBILE_START))
    echo ""
    echo "✅ Mobile Safari test passed! (${MOBILE_DURATION}s)"
    echo ""
else
    echo ""
    echo "❌ Mobile Safari test FAILED"
    echo ""
    echo "Mobile-specific tests failed."
    echo "Review the failures above."
    echo "To skip: git push --no-verify"
    echo ""
    exit 1
fi

TOTAL_DURATION=$((UNIT_DURATION + SMOKE_DURATION + FULL_DURATION + MOBILE_DURATION))

echo "========================================"
echo "  ✅ All tests passed! (${TOTAL_DURATION}s)"
echo "  Pushing to remote..."
echo "========================================"
echo ""
