/* Track row wrapper - contains main row + chromatic grid + plock editor */
.track-row-wrapper {
  display: flex;
  flex-direction: column;
  /* Phase 31G: Smooth transitions for drag reordering */
  transition: transform 0.15s ease-out, opacity 0.15s ease-out;
}

/* Phase 31G: Drop target indicator */
.track-row-wrapper.drag-target {
  position: relative;
}

.track-row-wrapper.drag-target::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--color-accent);
  border-radius: 2px;
  z-index: 10;
  box-shadow: 0 0 8px var(--color-accent);
}

/* Phase 31G: Dragging state - cursor only on drag handle, not whole row */
/* LOW-1: Visual feedback when this track is being dragged */
.track-row-wrapper.dragging {
  opacity: 0.5;
  transform: scale(0.98);
  background: var(--color-surface-elevated);
  border-radius: 4px;
}

/* Mobile: Track header (name only) - hidden on desktop */
.track-header-mobile {
  display: none;
}

/* Mobile: Edit panel toggle - hidden on desktop */
.mobile-edit-panel {
  display: none;
}

/*
 * TRACK ROW GRID LAYOUT (Phase 31: Implicit Grid)
 *
 * Uses CSS Grid with grouped columns for visual hierarchy:
 * | name | state | params | view | steps | actions |
 *
 * Group structure (2px internal gaps, 8px between groups):
 * - name:    Track name (70px)
 * - state:   [M · S] mute/solo buttons (26+2+26 = 54px)
 * - params:  [transpose · steps] dropdowns (60+2+60 = 122px)
 * - view:    [expand · pattern] panel toggles (24+2+24 = 50px)
 * - steps:   Step cells (1fr)
 * - actions: Copy/Clear/Delete (auto)
 *
 * The 2px gaps within groups create visual "chunks" that
 * the eye perceives as columns, improving scannability.
 */
.track-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  border-radius: 4px;
  transition: background 0.15s ease;
  /* Row expands to fit longest track's steps */
  min-width: max-content;
}

/* LEFT STICKY: Track controls stay fixed on left edge during scroll */
/*
 * CSS Grid Layout - columns exist whether content is present or not
 * This eliminates the need for spacer elements to maintain alignment.
 *
 * Phase 31H: Reordered columns for logical grouping
 * Grid columns: drag | name | mute | solo | transpose | badge | step-count | pitch-view | velocity | tools
 *
 * Control groups:
 * - [Drag] reorder handle
 * - [Name] identification
 * - [M S] playback state
 * - [Transpose Key Steps] pitch/timing params (grouped)
 * - [Expand Velocity Pattern] view controls
 */
.track-left {
  display: grid;
  grid-template-columns:
    [drag] 20px
    [name] 100px
    [mute] 36px
    [solo] 36px
    [transpose] 60px
    [badge] 36px
    [step-count] 60px
    [pitch-view] 36px
    [velocity] 36px
    [tools] 36px;
  column-gap: 4px;
  align-items: center;
  padding-left: 8px;
  padding-right: 8px;
  /* Sticky positioning */
  position: sticky;
  left: 0;
  z-index: 3;
  background: var(--color-surface);
  /* Subtle shadow to show content scrolling behind */
  box-shadow: 4px 0 8px -4px rgba(0, 0, 0, 0.2);
}

/* Grid column assignments for track controls */
.track-drag-handle { grid-column: drag; }
.track-name,
.track-name-input { grid-column: name; }
.mute-button { grid-column: mute; }
.solo-button { grid-column: solo; }
.expand-toggle { grid-column: pitch-view; }
.velocity-toggle { grid-column: velocity; }
.pattern-tools-toggle { grid-column: tools; }
/* Phase 31H: Pitch/Step group spans transpose + badge + step-count */
.track-pitch-step-group { grid-column: transpose / span 3; }

/* Phase 31G: Drag handle for track reordering */
.track-drag-handle {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 36px;
  color: var(--color-text-muted);
  opacity: 0.4;
  cursor: grab;
  transition: opacity 0.15s ease, color 0.15s ease;
  user-select: none;
  font-size: 12px;
  letter-spacing: -1px;
}

.track-drag-handle:hover {
  opacity: 0.8;
  color: var(--color-text);
}

.track-drag-handle:active {
  cursor: grabbing;
  opacity: 1;
  color: var(--color-accent);
}

/* RIGHT STICKY: Action buttons stay fixed on right edge during scroll */
.track-right {
  display: flex;
  align-items: center;
  padding-left: 8px;
  padding-right: 12px;
  /* Sticky positioning */
  position: sticky;
  right: 0;
  z-index: 3;
  background: var(--color-surface);
  /* Subtle shadow to show content scrolling behind */
  box-shadow: -4px 0 8px -4px rgba(0, 0, 0, 0.2);
}

/* Group containers removed - CSS Grid on .track-left handles alignment */
/* .track-transpose-group kept for connected border styling */

/* Mobile: Swim Lanes layout
 * - Horizontal scrolling tracks
 * - Tap track name to expand inline drawer
 * - No overflow menu - track name is the trigger
 *
 * LESSON FOR DESKTOP: The inline drawer pattern keeps context better
 * than modal dialogs. Could be backported for p-lock editing.
 */
@media (max-width: 768px) {
  .track-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    padding: 10px 0;
    border-bottom: 1px solid var(--color-surface-elevated);
  }

  /* Hide desktop-only controls on mobile */
  .transpose-control,
  .step-count-select,
  .track-actions {
    display: none;
  }

  /* Mute button - always visible, larger touch target */
  .mute-button {
    width: 36px;
    height: 36px;
    font-size: 13px;
    flex-shrink: 0;
  }

  /* Solo button - always visible, larger touch target */
  .solo-button {
    width: 36px;
    height: 36px;
    font-size: 13px;
    flex-shrink: 0;
  }

  /* Track name - tappable to open drawer */
  .track-name {
    flex: 0 0 auto;
    min-width: 60px;
    max-width: 80px;
    padding: 8px 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.1s ease;
  }

  .track-name:active {
    background: var(--color-surface-hover);
  }

  /* Expand toggle for synth tracks */
  .expand-toggle {
    flex-shrink: 0;
    order: 3;
  }

  .expand-placeholder {
    display: none;
  }

  /* Steps container - horizontal scroll */
  .steps {
    flex: 1;
    min-width: 0;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Firefox */
    padding: 4px 0;
  }

  .steps::-webkit-scrollbar {
    display: none;
  }

  /* Hint that track name is tappable */
  .track-row::after {
    content: '';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 5px solid var(--color-surface-active);
    opacity: 0;
    transition: opacity 0.15s;
    pointer-events: none;
  }

  /* Show expand hint when drawer is closed */
  .track-row-wrapper:not(:has(.inline-drawer)) .track-row::after {
    opacity: 1;
  }
}

/* Mobile Portrait: Read-mostly layout
 * Design:
 *   [Track Name + badges]         <- header row
 *   [Steps grid - full width]     <- swipeable steps
 *   [▼ tap to edit]               <- expandable panel trigger
 *   [Drawer with all controls]    <- expands on tap
 */
@media (max-width: 480px) and (orientation: portrait) {
  /* Show mobile-specific track header */
  .track-header-mobile {
    display: flex;
    align-items: center;
    padding: 8px 0 4px 0;
  }

  .track-name-mobile {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-text);
    text-transform: capitalize;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .track-header-mobile.muted .track-name-mobile {
    opacity: 0.5;
  }

  .track-header-mobile.soloed .track-name-mobile {
    color: var(--color-yellow);
  }

  .track-type-badge {
    font-size: 12px;
    color: var(--color-purple);
  }

  .track-status-badge {
    font-size: 10px;
    font-weight: bold;
    padding: 2px 5px;
    border-radius: 3px;
    margin-left: 4px;
  }

  .track-status-badge.muted {
    background: var(--color-error);
    color: white;
  }

  .track-status-badge.soloed {
    background: var(--color-yellow);
    color: var(--color-bg);
  }

  /* Hide ALL desktop track row controls */
  .track-row {
    display: block;
    padding: 0;
    border-bottom: none;
  }

  .track-row .mute-button,
  .track-row .solo-button,
  .track-row .track-name,
  .track-row .transpose-control,
  .track-row .step-count-select,
  .track-row .expand-toggle,
  .track-row .expand-placeholder,
  .track-row .track-actions {
    display: none !important;
  }

  /* Steps container - full width, swipeable */
  .track-row .steps {
    display: flex;
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding: 4px 0;
    /* Add right padding so last cell is partially cut off */
    padding-right: 24px;
    margin-right: -12px;
    scroll-snap-type: x proximity;
  }

  .track-row .steps::-webkit-scrollbar {
    display: none;
  }

  /* Remove arrow hint from track-row */
  .track-row::after {
    display: none;
  }

  /* Show mobile edit panel trigger */
  .mobile-edit-panel {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--color-surface-elevated);
    cursor: pointer;
    transition: background 0.1s ease;
  }

  .mobile-edit-panel:active {
    background: rgba(255, 255, 255, 0.05);
  }

  .mobile-edit-hint {
    font-size: 11px;
    color: var(--color-text-muted);
    letter-spacing: 0.5px;
  }

  .mobile-edit-panel.expanded .mobile-edit-hint {
    color: var(--color-text-muted);
  }
}

.track-row.muted {
  opacity: 0.5;
}

/* When soloed, track is highlighted slightly */
.track-row.soloed {
  background: var(--color-yellow-muted);
}

/* Copy mode states */
.track-row.copy-source {
  background: var(--color-green-muted);
}

.track-row.copy-target {
  background: var(--color-blue-muted);
}

.track-row.copy-target:hover {
  background: rgba(52, 152, 219, 0.2);
}

/* Elements inside groups - no grid-column assignments needed (using flex layout) */

.expand-toggle {
  width: 36px;
  height: 36px;
  border: 1px solid var(--color-surface-active);
  border-radius: 4px;
  background: var(--color-surface-elevated);
  color: var(--color-text-muted);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  flex-shrink: 0;
}

.expand-toggle:hover {
  background: var(--color-surface-hover);
  border-color: var(--color-text-muted);
}

.expand-toggle.expanded {
  background: var(--color-cyan-muted);
  border-color: var(--color-cyan);
  color: var(--color-cyan);
}

.expand-toggle svg {
  display: block;
}

/* Steps are in the middle, flex to fill available space */
.steps {
  flex: 1;
  min-width: 0;
}

/* Track actions are inside .track-right */


/* Track name - 36px height to match step cells for implicit grid */
.track-name {
  height: 36px;
  width: 80px; /* Fixed width for column alignment */
  flex-shrink: 0;
  display: flex;
  align-items: center;
  font-size: 13px;
  font-weight: 500;
  color: var(--color-text);
  text-transform: capitalize;
  padding: 0 4px;
  cursor: pointer;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.track-name:hover {
  color: var(--color-text-bright);
}

/* Phase 31D: Track name inline editing input */
.track-name-input {
  height: 36px;
  width: 80px; /* Match .track-name fixed width */
  flex-shrink: 0;
  font-size: 13px;
  font-weight: 500;
  color: var(--color-text);
  background: var(--color-surface-elevated);
  border: 1px solid var(--color-accent);
  border-radius: 4px;
  padding: 0 8px;
  outline: none;
  box-sizing: border-box;
}

.track-name-input:focus {
  border-color: var(--color-accent-light);
  box-shadow: 0 0 0 2px rgba(var(--color-accent-rgb, 255, 160, 100), 0.2);
}

/* Phase 31H: Pitch/Step group - Transpose + Key badge + Steps as one logical unit */
.track-pitch-step-group {
  display: flex;
  align-items: center;
  gap: 2px; /* Small gap - they're one logical group */
  height: 36px;
}

/* Phase 31H: Per-Track Key Display badge - matches dropdown styling */
.track-key-badge {
  font-family: var(--font-mono, 'SF Mono', 'Consolas', monospace);
  font-size: 13px;
  font-weight: 600;
  /* Fixed width for longest key (C#, D#, etc. = 2 chars) */
  min-width: 28px;
  text-align: center;
  /* Match dropdown styling */
  height: 36px;
  line-height: 36px;
  padding: 0 6px;
  background: var(--color-surface-elevated, #2a2a2a);
  border: 1px solid var(--color-border, #444);
  border-left: none; /* Connect to dropdown */
  border-radius: 0 4px 4px 0;
  box-sizing: border-box;
  flex-shrink: 0;
  transition: background 0.15s, color 0.15s, border-color 0.15s;
}

/* Active state - when there's an effective key to show */
.track-key-badge.active {
  color: var(--color-blue, #6eb5ff);
  background: var(--color-surface-elevated, #2a2a2a);
}

/* Placeholder state - greyed when transpose is 0 */
.track-key-badge.placeholder {
  color: var(--color-text-muted, #666);
  opacity: 0.5;
}

/* Empty placeholder for non-melodic tracks - maintains grid regularity */
.track-key-badge.placeholder-empty {
  visibility: hidden;
  /* Keep the same dimensions but invisible */
}

.track-key-badge:hover:not(.placeholder) {
  background: var(--color-surface-hover, #333);
  border-color: var(--color-accent, #ff6b35);
}

/* Adjust transpose dropdown border in group context */
.track-pitch-step-group .transpose-trigger {
  border-radius: 4px 0 0 4px;
}

/* When no badge (drums), adjust for step-count being adjacent */
.track-pitch-step-group:not(:has(.track-key-badge)) .transpose-trigger {
  border-radius: 4px 0 0 4px;
}

/* Step count dropdown in group - rounded right side */
.track-pitch-step-group .step-count-dropdown .step-count-trigger {
  border-radius: 0 4px 4px 0;
}

/* Phase 31: Unified button height of 36px to match step cells */
.mute-button {
  width: 36px;
  height: 36px;
  border: 1px solid var(--color-border-hover);
  border-radius: 4px;
  background: transparent;
  flex-shrink: 0;
  color: var(--color-text-muted);
  font-size: 11px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.15s ease;
}

.mute-button:hover {
  border-color: var(--color-text-muted);
  color: var(--color-text-muted);
}

.mute-button.active {
  background: var(--color-error);
  border-color: var(--color-error);
  color: white;
}

/* Solo button - industry standard yellow when active */
.solo-button {
  width: 36px;
  height: 36px;
  border: 1px solid var(--color-border-hover);
  border-radius: 4px;
  background: transparent;
  flex-shrink: 0;
  color: var(--color-text-muted);
  font-size: 11px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.15s ease;
}

.solo-button:hover {
  border-color: var(--color-text-muted);
  color: var(--color-text-muted);
}

.solo-button.active {
  background: var(--color-yellow);
  border-color: var(--color-yellow);
  color: var(--color-bg);
}

/* Track Volume Control - Phase 25 */
.track-volume-control {
  grid-column: volume;
  display: flex;
  align-items: center;
  height: 26px;
}

.track-volume-slider {
  width: 100%;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(90deg, var(--color-surface-active) 0%, var(--color-text-muted) 100%);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}

.track-volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--color-blue);
  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}

.track-volume-slider::-webkit-slider-thumb:hover {
  transform: scale(1.15);
  box-shadow: 0 0 6px var(--color-blue-muted);
}

.track-volume-slider::-moz-range-thumb {
  width: 12px;
  height: 12px;
  border: none;
  border-radius: 50%;
  background: var(--color-blue);
  cursor: pointer;
}

/* Transpose control - 36px height to match step cells for implicit grid */
.transpose-control {
  display: flex;
  align-items: center;
  gap: 2px;
  height: 36px;
}

.transpose-btn {
  width: 36px;
  height: 36px;
  border: 1px solid var(--color-surface-active);
  border-radius: 4px;
  background: var(--color-surface-elevated);
  color: var(--color-text-muted);
  font-size: 18px;
  font-weight: bold;
  line-height: 1;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.transpose-btn:hover:not(:disabled) {
  background: var(--color-surface-hover);
  border-color: var(--color-text-muted);
  color: var(--color-text);
}

.transpose-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

/* Note: .transpose-value styles are in TransposeDropdown.css */

/* Step count dropdown */
.step-count-select {
  grid-column: step-count;
  width: 60px;
  height: 36px;
  padding: 0 6px;
  border: 1px solid var(--color-surface-active);
  border-radius: 4px;
  background: var(--color-surface-elevated);
  color: var(--color-text-muted);
  font-size: 12px;
  font-weight: 600;
  font-family: monospace;
  cursor: pointer;
  transition: all 0.15s ease;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cpath fill='%23888' d='M0 2l4 4 4-4z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 8px center;
  padding-right: 20px;
}

.step-count-select:hover {
  background-color: var(--color-surface-hover);
  border-color: var(--color-text-muted);
  color: var(--color-text);
}

.step-count-select:focus {
  outline: none;
  border-color: var(--color-purple);
}

.step-count-select option {
  background: var(--color-surface);
  color: var(--color-text);
}

/* Steps grid - no individual scrollbar, parent .tracks scrolls all together */
.steps {
  display: flex;
  gap: 3px;
  flex-shrink: 0; /* Don't shrink - let parent scroll */
}

/* Track actions - fixed column, doesn't scroll
 * Each track has its own scroll context for steps, so actions stay fixed
 */
.track-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
  justify-content: flex-end;
  padding-right: 12px;
}

/* Mobile: Hide track actions - controls available via drawer/menu */
@media (max-width: 768px) {
  .track-actions {
    display: none;
  }
}

/* Phase 31: Unified button height of 36px to match step cells */
.action-btn {
  height: 36px;
  padding: 0 10px;
  border: 1px solid var(--color-surface-active);
  border-radius: 4px;
  background: var(--color-surface-elevated);
  color: var(--color-text-muted);
  font-size: 11px;
  font-weight: 600;
  font-family: monospace;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
}

.action-btn:hover:not(:disabled) {
  background: var(--color-surface-hover);
  border-color: var(--color-text-muted);
  color: var(--color-text-muted);
}

.action-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.action-btn.delete:hover:not(:disabled) {
  background: var(--color-error);
  border-color: var(--color-error);
  color: white;
}

.action-btn.paste {
  background: var(--color-success);
  border-color: var(--color-success);
  color: white;
}

.action-btn.paste:hover {
  filter: brightness(1.1);
}

/* Inline Parameter Lock Editor */
.plock-inline {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 8px 12px;
  background: var(--color-surface-elevated);
  border-radius: 6px;
  margin-top: 6px;
  width: 100%;
}

.plock-step {
  font-size: 12px;
  color: var(--color-text-muted);
  font-weight: 500;
  min-width: 50px;
}

.plock-control {
  display: flex;
  align-items: center;
  gap: 8px;
}

.plock-param {
  display: flex;
  align-items: center;
  gap: 8px;
}

.plock-label {
  font-size: 11px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
}

.plock-label.pitch {
  background: var(--color-blue);
  color: white;
}

.plock-label.volume {
  background: var(--color-accent);
  color: white;
}

.plock-slider-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.plock-slider {
  width: 80px;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--color-surface-active);
  border-radius: 2px;
  outline: none;
}

.plock-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  cursor: pointer;
}

.plock-slider.pitch::-webkit-slider-thumb {
  background: var(--color-blue);
}

.plock-slider.volume::-webkit-slider-thumb {
  background: var(--color-accent);
}

.plock-value {
  font-size: 12px;
  color: var(--color-text-muted);
  min-width: 35px;
  text-align: right;
  font-family: monospace;
}

.plock-clear {
  padding: 4px 8px;
  border: 1px solid var(--color-error);
  border-radius: 4px;
  background: transparent;
  color: var(--color-error);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.15s ease;
  margin-left: auto;
}

.plock-clear:hover {
  background: var(--color-error);
  color: white;
}

/* Phase 29B: Tie toggle button */
.plock-tie {
  padding: 4px 8px;
  border: 1px solid var(--color-text-muted);
  border-radius: 4px;
  background: transparent;
  color: var(--color-text-muted);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.15s ease;
  margin-left: 8px;
}

.plock-tie:hover {
  border-color: var(--color-blue);
  color: var(--color-blue);
}

.plock-tie.active {
  border-color: var(--color-blue);
  background: var(--color-blue);
  color: white;
}

/* Out-of-range pitch warning styles */
.plock-label.out-of-range,
.plock-value.out-of-range {
  color: var(--color-error);
}

.plock-label.pitch.out-of-range {
  background: var(--color-error);
  color: white;
}

.plock-slider.pitch.out-of-range {
  opacity: 0.7;
}

.plock-slider.pitch.out-of-range::-webkit-slider-thumb {
  background: var(--color-error);
}

/* FM Synthesis Controls Panel
   DESIGN NOTE: FM controls use a distinct purple/blue color scheme to visually
   differentiate them from other track controls. This creates a "synth module"
   aesthetic inspired by hardware FM synthesizers like the DX7. The purple tones
   (#1a1a2e, #16213e, #8a8aff) are intentionally hardcoded to maintain this
   distinctive appearance regardless of theme settings. */
.fm-controls-panel {
  display: flex;
  align-items: center;
  gap: 24px;
  padding: 10px 16px;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  border-radius: 6px;
  margin-top: 6px;
  border: 1px solid #2a2a4a;
}

.fm-control {
  display: flex;
  align-items: center;
  gap: 10px;
}

.fm-label {
  font-size: 11px;
  font-weight: 600;
  color: #8a8aff;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  min-width: 85px;
}

.fm-slider {
  width: 120px;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(90deg, #3a3a6a 0%, #5a5aaa 100%);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}

.fm-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #8a8aff;
  cursor: pointer;
  box-shadow: 0 0 6px rgba(138, 138, 255, 0.5);
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}

.fm-slider::-webkit-slider-thumb:hover {
  transform: scale(1.1);
  box-shadow: 0 0 10px rgba(138, 138, 255, 0.7);
}

.fm-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border: none;
  border-radius: 50%;
  background: #8a8aff;
  cursor: pointer;
  box-shadow: 0 0 6px rgba(138, 138, 255, 0.5);
}

.fm-value {
  font-size: 12px;
  color: #aaaaff;
  min-width: 40px;
  text-align: right;
  font-family: monospace;
  font-weight: 500;
}

/* Mobile: Stack FM controls vertically */
@media (max-width: 768px) {
  .fm-controls-panel {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
    padding: 12px;
  }

  .fm-control {
    justify-content: space-between;
  }

  .fm-slider {
    flex: 1;
    max-width: 150px;
  }
}

/* ===== Phase 31: Unified Panel Animation ===== */
/* Matches FX panel animation - smooth height transition using grid-template-rows */

.panel-animation-container {
  display: grid;
  grid-template-rows: 0fr;
  transition: grid-template-rows 0.25s ease-out;
  overflow: hidden;
}

.panel-animation-container.expanded {
  grid-template-rows: 1fr;
  /* FIX: Remove overflow:hidden when expanded to allow sticky children.
   * overflow:hidden breaks position:sticky because it clips sticky elements.
   * We use overflow:clip during collapse animation (handled by not-expanded state),
   * but once expanded, we need visible overflow for sticky to work. */
  overflow: visible;
}

.panel-animation-content {
  min-height: 0;
  /* overflow:hidden needed for collapse animation to clip content */
  overflow: hidden;
}

/* FIX: Allow overflow when parent is expanded so sticky children work */
.panel-animation-container.expanded > .panel-animation-content {
  overflow: visible;
}

/* ===== Phase 31B: Pattern Tools ===== */

/* Pattern tools toggle button - inside view group */
.pattern-tools-toggle {
  width: 36px;
  height: 36px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  border: 1px solid var(--color-surface-active);
  border-radius: 4px;
  background: var(--color-surface-elevated);
  color: var(--color-text-muted);
  cursor: pointer;
  transition: all 0.15s ease;
  flex-shrink: 0;
}

.pattern-tools-toggle:hover {
  background: var(--color-surface-hover);
  border-color: var(--color-text-muted);
}

.pattern-tools-toggle.active {
  background: var(--color-cyan-muted);
  border-color: var(--color-cyan);
  color: var(--color-cyan);
}

/* Pattern tools panel - appears below track row */
.pattern-tools-panel {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 8px 12px;
  background: var(--color-surface-elevated);
  border-radius: 6px;
  margin-top: 4px;
  margin-bottom: 4px;
  flex-wrap: wrap;
  /* Constrain to viewport so controls don't overflow the visible area.
   * 170px accounts for left margin (48px), right padding (48px), and buffer (74px).
   * Slider groups with flex: 1 will fill this constrained space. */
  max-width: calc(100vw - 170px);
  /* FIX: Sticky positioning keeps panel visible during horizontal scroll.
   * Without this, scrolling right to view steps 65+ causes the panel to
   * scroll off-screen to the left, making Euclidean/Swing controls inaccessible.
   * Matches the pattern used by .track-left for consistent scroll behavior. */
  position: sticky;
  left: 0;
  z-index: 2; /* Below .track-left (z-index: 3) to avoid overlap conflicts */
}

.pattern-tools-group {
  display: flex;
  align-items: center;
  gap: 4px;
}

.pattern-tools-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--color-text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-right: 4px;
}

.pattern-tool-btn {
  width: 28px;
  height: 28px;
  border: 1px solid var(--color-surface-active);
  border-radius: 4px;
  background: var(--color-surface);
  color: var(--color-text-muted);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pattern-tool-btn:hover:not(:disabled) {
  background: var(--color-surface-hover);
  border-color: var(--color-purple);
  color: var(--color-purple);
}

.pattern-tool-btn:active:not(:disabled) {
  transform: scale(0.95);
}

.pattern-tool-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

/*
 * Euclidean and Swing groups - CSS Grid for label/slider/value alignment
 * Grid columns: [label] auto | [slider] 1fr | [value] auto
 * flex: 1 ensures they fill available space equally within the viewport-constrained panel.
 * min-width: 100px provides usable slider width while allowing shrinkage on narrow viewports.
 */
.euclidean-group,
.swing-group {
  display: grid;
  grid-template-columns: [label] auto [slider] 1fr [value] auto;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 100px;
}

/* Grid column assignments for slider groups */
.euclidean-group .pattern-tools-label,
.swing-group .pattern-tools-label {
  grid-column: label;
}

.euclidean-slider,
.track-swing-slider {
  grid-column: slider;
}

.euclidean-value,
.swing-value {
  grid-column: value;
}

.euclidean-slider {
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(90deg, var(--color-surface-active) 0%, var(--color-teal) 100%);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}

.euclidean-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--color-teal);
  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}

.euclidean-slider::-webkit-slider-thumb:hover {
  transform: scale(1.15);
  box-shadow: 0 0 6px var(--color-teal-muted);
}

.euclidean-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border: none;
  border-radius: 50%;
  background: var(--color-teal);
  cursor: pointer;
}

.euclidean-value {
  font-size: 11px;
  font-weight: 600;
  color: var(--color-teal);
  font-family: monospace;
  min-width: 35px;
}

/* Phase 31D: Per-track swing slider styling */
.track-swing-slider {
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(90deg, var(--color-surface-active) 0%, var(--color-cyan) 100%);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}

.track-swing-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--color-cyan);
  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}

.track-swing-slider::-webkit-slider-thumb:hover {
  transform: scale(1.15);
  box-shadow: 0 0 6px var(--color-cyan-muted);
}

.track-swing-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border: none;
  border-radius: 50%;
  background: var(--color-cyan);
  cursor: pointer;
}

.swing-value {
  font-size: 11px;
  font-weight: 600;
  color: var(--color-cyan);
  font-family: monospace;
  min-width: 32px; /* Reduced: no longer needs to fit "Global" */
}

/* Mobile pattern tools in drawer */
.drawer-pattern-tools {
  display: flex;
  gap: 6px;
}

.drawer-pattern-btn {
  width: 36px;
  height: 36px;
  border: 1px solid var(--color-surface-active);
  border-radius: 6px;
  background: var(--color-surface);
  color: var(--color-text-muted);
  font-size: 16px;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.drawer-pattern-btn:hover:not(:disabled) {
  background: var(--color-surface-hover);
  border-color: var(--color-purple);
  color: var(--color-purple);
}

.drawer-pattern-btn:active:not(:disabled) {
  transform: scale(0.95);
}

.drawer-pattern-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.drawer-euclidean-slider {
  flex: 1;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(90deg, var(--color-surface-active) 0%, var(--color-teal) 100%);
  border-radius: 3px;
  outline: none;
  cursor: pointer;
}

.drawer-euclidean-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--color-teal);
  cursor: pointer;
}

.drawer-euclidean-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border: none;
  border-radius: 50%;
  background: var(--color-teal);
  cursor: pointer;
}

/* Hide desktop pattern tools panel on mobile */
@media (max-width: 768px) {
  .pattern-tools-panel {
    display: none;
  }
}

/* ===== Phase 31C: Category Color Coding ===== */

/* Category color border on left side of track row
 * Uses data-category attribute to apply appropriate color
 * 4px border is subtle but visible for scanning
 */
.track-row {
  border-left: 4px solid transparent;
}

.track-row[data-category="drums"] {
  border-left-color: var(--color-drums, var(--color-orange));
}

.track-row[data-category="bass"] {
  border-left-color: var(--color-bass, var(--color-purple));
}

.track-row[data-category="keys"] {
  border-left-color: var(--color-keys, var(--color-blue));
}

.track-row[data-category="leads"] {
  border-left-color: var(--color-leads, var(--color-pink));
}

.track-row[data-category="pads"] {
  border-left-color: var(--color-pads, var(--color-green));
}

.track-row[data-category="fx"] {
  border-left-color: var(--color-fx, var(--color-cyan));
}

/* ===== Phase 31H: Pitch View Toggle Tabs ===== */

.pitch-view-header {
  display: flex;
  align-items: center;
  padding: 8px 12px 4px;
  background: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
}

.pitch-view-tabs {
  display: flex;
  gap: 2px;
  background: var(--color-surface-elevated);
  border-radius: 6px;
  padding: 2px;
}

.pitch-view-tab {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  background: transparent;
  color: var(--color-text-muted);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
}

.pitch-view-tab:hover {
  color: var(--color-text);
  background: rgba(255, 255, 255, 0.05);
}

.pitch-view-tab.active {
  background: var(--color-accent);
  color: var(--color-bg);
}

/* Mobile: Hide pitch view on mobile (chromatic grid is better for touch) */
@media (max-width: 768px) {
  .pitch-view-header {
    display: none;
  }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .panel-animation-container {
    transition: none;
  }

  .pitch-view-tab {
    transition: none;
  }
}

/* ==========================================================================
   LANDSCAPE MOBILE - Compact Track Row Layout

   In landscape mobile mode, we restructure the track row for maximum grid visibility:
   - Layout: M(32px) | S(32px) | Name(60-80px) | Steps(1fr)
   - Hide all inline controls (moved to TrackDrawer)
   - Track name tap toggles drawer with chevron indicator
   - M/S buttons work instantly without drawer interference
   - Step grid shows 15-16 steps (vs 5-6 in old mobile)
   ========================================================================== */

@media (max-width: 768px) and (orientation: landscape) {
  /* Track row wrapper - compact layout */
  .track-row-wrapper {
    margin-bottom: 2px;
  }

  /* Hide mobile header (name row) - use inline name instead */
  .track-header-mobile {
    display: none !important;
  }

  /* Hide mobile edit panel - using TrackDrawer instead */
  .mobile-edit-panel {
    display: none !important;
  }

  /* Track row - simple flex layout for landscape */
  .track-row {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 0;
    min-width: unset; /* Don't expand to fit content */
  }

  /* Track left - compact grid for M/S and name only */
  .track-left {
    display: grid;
    grid-template-columns:
      [mute] 36px
      [solo] 36px
      [name] minmax(60px, 80px);
    column-gap: 4px;
    align-items: center;
    padding: 0 4px;
    /* Sticky positioning */
    position: sticky;
    left: 0;
    z-index: 3;
    background: var(--color-surface);
    box-shadow: 2px 0 4px -2px rgba(0, 0, 0, 0.2);
  }

  /* Hide all desktop controls in landscape mobile */
  .track-left .track-drag-handle,
  .track-left .track-pitch-step-group,
  .track-left .expand-toggle,
  .track-left .velocity-toggle,
  .track-left .pattern-tools-toggle {
    display: none !important;
  }

  /* Compact M/S buttons - explicitly set grid positions for single row */
  /* 36px touch targets for better accessibility (iOS HIG recommends 44px min) */
  .track-left .mute-button {
    grid-column: 1;
    grid-row: 1;
    width: 36px;
    height: 36px;
    font-size: 11px;
    border-radius: 4px;
  }

  .track-left .solo-button {
    grid-column: 2;
    grid-row: 1;
    width: 36px;
    height: 36px;
    font-size: 11px;
    border-radius: 4px;
  }

  /* Track name - tappable with chevron */
  .track-left .track-name {
    grid-column: 3;
    grid-row: 1;
    width: auto;
    min-width: 60px;
    max-width: 80px;
    height: 36px;
    padding: 0 8px;
    font-size: 12px;
    cursor: pointer;
    position: relative;
    background: var(--color-surface-elevated);
    border-radius: 4px;
    transition: background 0.1s ease;
  }

  .track-left .track-name:active {
    background: var(--color-surface-hover);
  }

  /* Chevron indicator on track name */
  .track-left .track-name::after {
    content: '▾';
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    color: var(--color-text-muted);
    transition: transform 0.2s ease;
  }

  /* Rotate chevron when drawer is open */
  .track-row-wrapper:has(.track-drawer) .track-name::after {
    transform: translateY(-50%) rotate(180deg);
  }

  /* Track right - hide actions (moved to drawer) */
  .track-right {
    display: none;
  }

  /* Steps container - full width after controls */
  .track-row .steps {
    flex: 1;
    min-width: 0;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding: 0; /* No vertical padding - align with M/S buttons */
    gap: 2px;
  }

  .track-row .steps::-webkit-scrollbar {
    display: none;
  }

  /* Compact step cells for landscape - 36px for better touch targets */
  .track-row .step-cell {
    width: 36px;
    height: 36px;
    min-width: 36px;
    border-radius: 4px;
    border-width: 2px;
  }

  .track-row .step-cell.beat-start {
    border-left-width: 2px;
  }

  .track-row .step-cell.playing {
    border-width: 2px;
  }

  /* Hide expanded panels in landscape - too cramped */
  .panel-animation-container,
  .fm-controls-panel {
    display: none !important;
  }

  /* Inline drawer (existing) - hide in landscape, use TrackDrawer instead */
  .inline-drawer {
    display: none !important;
  }
}
