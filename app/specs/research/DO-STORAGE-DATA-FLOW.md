# DO Storage Data Flow Architecture

## Terminology

**Mutation** = Any state-changing action from a client:
- `toggle_step` (click a grid cell)
- `add_track` (add a new track)
- `set_tempo` (change BPM)
- `set_track_volume`, `delete_track`, etc.

**"DO per-mutation"** = Write to Durable Object storage (`ctx.storage.put()`) on every single mutation, not debounced.

---

## Current Architecture (KV Debounced)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CURRENT DATA FLOW                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  CLIENT A                    DURABLE OBJECT                         KV STORAGE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚                             â”‚                                     â”‚
      â”‚  1. toggle_step             â”‚                                     â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                     â”‚
      â”‚        (WebSocket)          â”‚                                     â”‚
      â”‚                             â”‚                                     â”‚
      â”‚                        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                â”‚
      â”‚                        â”‚ Memory  â”‚  2. Apply mutation             â”‚
      â”‚                        â”‚  State  â”‚     state.tracks[0].steps[3]=T â”‚
      â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                â”‚
      â”‚                             â”‚                                     â”‚
      â”‚                             â”‚  3. Start/reset 5s timer            â”‚
      â”‚                             â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
      â”‚                             â”‚     â”‚ debounceTimer   â”‚             â”‚
      â”‚                             â”‚     â”‚ (5000ms)        â”‚             â”‚
      â”‚                             â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
      â”‚                             â”‚                                     â”‚
      â”‚  4. Broadcast to clients    â”‚                                     â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                     â”‚
      â”‚     step_toggled            â”‚                                     â”‚
      â”‚                             â”‚                                     â”‚
      â”‚  5. Another toggle_step     â”‚                                     â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                     â”‚
      â”‚        (50ms later)         â”‚                                     â”‚
      â”‚                             â”‚  6. Reset timer to 5s again!        â”‚
      â”‚                             â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
      â”‚                             â”‚     â”‚ debounceTimer   â”‚â—„â”€â”€ RESET    â”‚
      â”‚                             â”‚     â”‚ (5000ms)        â”‚             â”‚
      â”‚                             â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
      â”‚                             â”‚                                     â”‚
      Â·                             Â·                                     Â·
      Â·  (user keeps clicking...)   Â·                                     Â·
      Â·                             Â·                                     Â·
      â”‚                             â”‚                                     â”‚
      â”‚                             â”‚  7. Finally 5s of silence...        â”‚
      â”‚                             â”‚                                     â”‚
      â”‚                             â”‚  8. Write to KV                     â”‚
      â”‚                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                             â”‚     PUT /sessions/{id}              â”‚
      â”‚                             â”‚     { state: {...} }                â”‚
      â”‚                             â”‚                                     â”‚
```

---

## The Vulnerability Window

```
  âš ï¸  THE VULNERABILITY WINDOW:
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      â”‚                             â”‚                                     â”‚
      â”‚  toggle_step (x10)          â”‚                                     â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Memory has all 10 changes          â”‚
      â”‚                             â”‚                                     â”‚
      â”‚                             â”‚  Timer still counting down...       â”‚
      â”‚                             â”‚                                     â”‚
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
      â”‚         â”‚     ğŸ’¥ DO EVICTED (idle timeout,      â”‚                 â”‚
      â”‚         â”‚        deployment, memory pressure)   â”‚                 â”‚
      â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
      â”‚                             â”‚                                     â”‚
      â”‚                             â–¼                                     â”‚
      â”‚                        â•”â•â•â•â•â•â•â•â•â•â•—                                â”‚
      â”‚                        â•‘ MEMORY  â•‘                                â”‚
      â”‚                        â•‘  LOST!  â•‘  KV still has OLD state        â”‚
      â”‚                        â•šâ•â•â•â•â•â•â•â•â•â•                                â”‚
      â”‚                                                                   â”‚
      â”‚  CLIENT B CONNECTS                                                â”‚
      â”‚                             â”‚                                     â”‚
      â”‚                        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                â”‚
      â”‚                        â”‚  NEW DO â”‚  1. Check DO storage (empty)   â”‚
      â”‚                        â”‚ INSTANCEâ”‚  2. Load from KV (STALE!)      â”‚
      â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                â”‚
      â”‚                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                             â”‚     GET (stale state)               â”‚
      â”‚                             â”‚                                     â”‚
      â”‚  Snapshot (missing 10 changes!)                                   â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                     â”‚
      â”‚     ğŸ˜¢ DATA LOST            â”‚                                     â”‚
```

---

## Proposed Architecture (DO Storage Per-Mutation)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          PROPOSED DATA FLOW                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  CLIENT A                    DURABLE OBJECT                         STORAGE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚                             â”‚                           DO Storage â”‚ KV
      â”‚                             â”‚                           (durable)  â”‚(API)
      â”‚  1. toggle_step             â”‚                               â”‚      â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                               â”‚      â”‚
      â”‚        (WebSocket)          â”‚                               â”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
      â”‚                        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                          â”‚      â”‚
      â”‚                        â”‚ Memory  â”‚  2. Apply mutation       â”‚      â”‚
      â”‚                        â”‚  State  â”‚                          â”‚      â”‚
      â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                          â”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
      â”‚                             â”‚  3. IMMEDIATE write to        â”‚      â”‚
      â”‚                             â”‚     DO storage (sync)         â”‚      â”‚
      â”‚                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚      â”‚
      â”‚                             â”‚   ctx.storage.put('state',    â”‚      â”‚
      â”‚                             â”‚                    state)     â”‚      â”‚
      â”‚                             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
      â”‚                             â”‚   âœ… Durably persisted        â”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
      â”‚  4. Broadcast to clients    â”‚                               â”‚      â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚      â”‚
      â”‚     step_toggled            â”‚                               â”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
      â”‚                             â”‚  5. Schedule KV write         â”‚      â”‚
      â”‚                             â”‚     (debounced, async)        â”‚      â”‚
      â”‚                             â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚      â”‚
      â”‚                             â”‚     â”‚ kvDebounce(5s)  â”‚â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€>â”‚
      â”‚                             â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚      â”‚
      â”‚                             â”‚     (fire and forget)         â”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
```

---

## No Vulnerability Window

```
  âœ…  NO VULNERABILITY WINDOW:
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      â”‚                             â”‚                               â”‚      â”‚
      â”‚  toggle_step (x10)          â”‚                               â”‚      â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                               â”‚      â”‚
      â”‚                             â”‚  Each mutation:               â”‚      â”‚
      â”‚                             â”‚    Memory âœ“                   â”‚      â”‚
      â”‚                             â”‚    DO Storage âœ“ (immediate)   â”‚      â”‚
      â”‚                             â”‚    KV (debounced, eventual)   â”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚      â”‚
      â”‚         â”‚     ğŸ’¥ DO EVICTED                     â”‚           â”‚      â”‚
      â”‚         â”‚        (doesn't matter anymore!)      â”‚           â”‚      â”‚
      â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
      â”‚                             â–¼                               â”‚      â”‚
      â”‚                        â•”â•â•â•â•â•â•â•â•â•â•—                          â”‚      â”‚
      â”‚                        â•‘ Memory  â•‘  But DO Storage          â”‚      â”‚
      â”‚                        â•‘  gone   â•‘  still has all 10!       â”‚      â”‚
      â”‚                        â•šâ•â•â•â•â•â•â•â•â•â•                          â”‚      â”‚
      â”‚                                                             â”‚      â”‚
      â”‚  CLIENT B CONNECTS                                          â”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
      â”‚                        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                          â”‚      â”‚
      â”‚                        â”‚  NEW DO â”‚  1. Check DO storage     â”‚      â”‚
      â”‚                        â”‚ INSTANCEâ”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
      â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  âœ… Found! All 10 changesâ”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
      â”‚                             â”‚  2. Skip KV (not needed)      â”‚      â”‚
      â”‚                             â”‚                               â”‚      â”‚
      â”‚  Snapshot (all 10 changes!) â”‚                               â”‚      â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚      â”‚
      â”‚     âœ… NO DATA LOST         â”‚                               â”‚      â”‚
```

---

## Storage Hierarchy Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STORAGE HIERARCHY                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    CURRENT                          PROPOSED
                    â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€

                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Memory  â”‚ â—„â”€â”€ Fast            â”‚  Memory  â”‚ â—„â”€â”€ Fast
                 â”‚ (in DO)  â”‚     Volatile!       â”‚ (in DO)  â”‚     Volatile
                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                      â”‚                                â”‚
                      â”‚ 5s debounce                    â”‚ Immediate (sync)
                      â–¼                                â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚     KV     â”‚ â—„â”€â”€ Durable       â”‚ DO Storage â”‚ â—„â”€â”€ Durable
               â”‚            â”‚     but stale!    â”‚(ctx.storageâ”‚     & fresh!
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â”‚ 5s debounce (async)
                                                      â–¼
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚     KV     â”‚ â—„â”€â”€ For API
                                                â”‚            â”‚     reads only
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


  LOAD ORDER ON DO WAKE:

  Current:   KV only (may be stale)
  Proposed:  DO Storage first â†’ KV fallback (only for legacy sessions)
```

---

## Code Change

```typescript
// CURRENT: live-session.ts
async handleMutation(msg: ClientMessage) {
  this.applyToMemory(msg);           // 1. Memory (volatile)
  this.broadcast(msg);               // 2. Tell clients
  this.scheduleKVFlush();            // 3. Debounced KV write
}

// PROPOSED: live-session.ts
async handleMutation(msg: ClientMessage) {
  this.applyToMemory(msg);           // 1. Memory
  await this.ctx.storage.put(        // 2. DO Storage (DURABLE!) â† NEW
    'state',
    this.state
  );
  this.broadcast(msg);               // 3. Tell clients
  this.scheduleKVFlush();            // 4. Debounced KV (for API)
}
```

The single added line (`await this.ctx.storage.put(...)`) ensures every mutation is durably persisted before the client is told it succeeded.

---

## Summary

| Aspect | Current (KV Debounced) | Proposed (DO Storage) |
|--------|------------------------|----------------------|
| **Write timing** | Every 5s (debounced) | Every mutation (immediate) |
| **Durability** | Volatile for up to 5s | Immediate |
| **Data loss risk** | 100% of recent changes | None |
| **Cost** | ~$145/month at 1M sessions | ~$149/month at 1M sessions |
| **Latency added** | None | ~1-2ms per mutation |
| **Complexity** | Simple | Simple (one line change) |

---

## DECISION: Hybrid Approach Selected

The final implementation uses **DO Storage per-mutation + KV write on-disconnect only**:

```
  CLIENT                    DURABLE OBJECT                      STORAGE
  â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚                           â”‚                        DO Storage â”‚ KV
      â”‚  mutation                 â”‚                            â”‚      â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚      â”‚
      â”‚                           â”‚                            â”‚      â”‚
      â”‚                      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                       â”‚      â”‚
      â”‚                      â”‚ Memory  â”‚  1. Apply             â”‚      â”‚
      â”‚                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                       â”‚      â”‚
      â”‚                           â”‚                            â”‚      â”‚
      â”‚                           â”‚  2. ctx.storage.put()      â”‚      â”‚
      â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚      â”‚
      â”‚                           â”‚     (immediate, ~1ms)      â”‚      â”‚
      â”‚                           â”‚                            â”‚      â”‚
      â”‚  broadcast                â”‚                            â”‚      â”‚
      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  3. Tell clients           â”‚      â”‚
      â”‚                           â”‚                            â”‚      â”‚
      â”‚                           â”‚  (NO KV write here!)       â”‚      â”‚
      â”‚                           â”‚                            â”‚      â”‚
      Â·  (more mutations...)      Â·                            Â·      Â·
      â”‚                           â”‚                            â”‚      â”‚
      â”‚  disconnect               â”‚                            â”‚      â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚      â”‚
      â”‚                           â”‚  4. Last client left       â”‚      â”‚
      â”‚                           â”‚                            â”‚      â”‚
      â”‚                           â”‚  5. KV.put() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€>â”‚
      â”‚                           â”‚     (single write)         â”‚      â”‚
      â”‚                           â”‚                            â”‚      â”‚
```

### Why Hybrid?

| Approach | DO writes/session | KV writes/session | Cost at 1M sessions |
|----------|-------------------|-------------------|---------------------|
| Current (KV debounced) | 0 | 30 | $145 |
| Naive DO + KV | 150 | 30 | $294 |
| **Hybrid** | 150 | 1 | **$149** |

Hybrid eliminates the KV debounce overhead, saving $145/month at scale.

---

## Related Documents

- [KV Staleness Fix Options](./KV-STALENESS-FIX-OPTIONS.md) - All fix options considered
- [Cost Analysis](./COST-ANALYSIS-DO-STORAGE.md) - Detailed cost comparison
- [KV Staleness Test](../../test/staging/kv-staleness.test.ts) - Tests demonstrating the bug
